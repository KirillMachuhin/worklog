{% extends "../base.html" %}

{% block extra_head %}
{{ modules.Static("css/smoothness/jquery-ui-1.8.6.slider.datepicker.css") }}
{% end %}

{% block content_inner %}

<h1>Full report</h1>

<form action=".">

<div id="slider" style="width:500px"></div>
<p style="margin-top:10px">
<strong>From:</strong>
<input type="text" id="from_date" name="from_date" value="">
<strong>To:</strong>
<input type="text" id="to_date" name="to_date" value="">
</p>
<!--
<label for="from">From</label> 
<input type="text" id="from" name="from" value="" readonly="readonly" /> 
<label for="to">to</label> 
<input type="text" id="to" name="to" value="" readonly="readonly" />
-->

</form>


{% end %}	    
{% block extrajs %}
{{ modules.Static("ext/jquery-ui-1.8.6.slider.datepicker.min.js") }}
<script type="text/javascript">
var minDate = new Date({{ first_date.year }}, {{ first_date.month }}-1, {{ first_date.day }});
var maxDate = new Date({{ last_date.year }}, {{ last_date.month }}-1, {{ last_date.day }});
var slider;
var startDate;
var endDate;
var dateformat = 'd M yy';
var still_sliding = false;
$(function() {
    if (!$('#from_date').val()) {
      $('#from_date').val($.datepicker.formatDate(dateformat, minDate));
    }
    if (!$('#to_date').val()) {
      $('#to_date').val($.datepicker.formatDate(dateformat, maxDate));
    }
    
    slider = $('#slider').slider({range: true, max: daysDiff(minDate, maxDate),
            stop: function(event, ui) {
              still_sliding = false;
              refresh_date_range();
            },
            slide: function(event, ui) { resync(ui.values); }});
    startDate = $('#from_date').datepicker({
        firstDay: SETTINGS.monday_first ? 1 : 0,
        minDate: minDate, 
        maxDate: maxDate,
        dateFormat: dateformat,
        onSelect: function(dateStr) { 
          resync();
          refresh_date_range();
        }}).
        keyup(function() { resync(); });
    endDate = $('#to_date').datepicker({
        firstDay: SETTINGS.monday_first ? 1 : 0,
            minDate: minDate, 
            maxDate: maxDate,
            dateFormat: dateformat,
            onSelect: function(dateStr) { 
              resync();
              refresh_date_range();
            }}).
        keyup(function() { resync(); });
    resync();
});

function refresh_date_range() {
  console.log(startDate.datepicker('getDate').getTime());
  console.log(endDate.datepicker('getDate').getTime());
}

function resync(values) {
    if (values) {
        var date = new Date(minDate.getTime());
        date.setDate(date.getDate() + values[0]);
        startDate.val($.datepicker.formatDate(dateformat, date));
        date = new Date(minDate.getTime());
        date.setDate(date.getDate() + values[1]);
        endDate.val($.datepicker.formatDate(dateformat, date));
    }
    else {
        var start = daysDiff(minDate, startDate.datepicker('getDate') || minDate);
        var end = daysDiff(minDate, endDate.datepicker('getDate') || maxDate);
        start = Math.min(start, end);
        slider.slider('values', 0, start);
        slider.slider('values', 1, end);
    }
    startDate.datepicker('option', 'maxDate', endDate.datepicker('getDate') || maxDate);
    endDate.datepicker('option', 'minDate', startDate.datepicker('getDate') || minDate);
}

function daysDiff(d1, d2) {
    return  Math.floor((d2.getTime() - d1.getTime()) / 86400000);
}
</script>
{% end %}
